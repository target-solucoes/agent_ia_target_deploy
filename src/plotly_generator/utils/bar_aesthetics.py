"""
BarAesthetics - Configurações estéticas centralizadas para gráficos de barras.

Este módulo centraliza todas as configurações visuais estéticas para
gráficos de barras (horizontais e verticais), garantindo consistência
e facilidade de manutenção.

Principais recursos:
- Tamanho de fonte otimizado para rótulos categóricos
- Espaçamento adequado entre rótulos e barras
- Margens configuráveis
- Configuração de padding e gap
"""

from typing import Dict, Any, Optional
import plotly.graph_objects as go

from src.shared_lib.utils.logger import get_logger

logger = get_logger(__name__)


class BarAestheticsConfig:
    """
    Configurações estéticas para gráficos de barras.

    Todas as configurações podem ser ajustadas centralmente aqui.
    """

    # ==================== CONFIGURAÇÕES DE FONTE ====================

    # Tamanho de fonte para rótulos categóricos (eixo Y em horizontal, eixo X em vertical)
    CATEGORY_LABEL_FONT_SIZE = 14  # Aumentado de 9-11 para 14

    # Tamanho de fonte para valores numéricos (eixo X em horizontal, eixo Y em vertical)
    VALUE_LABEL_FONT_SIZE = 13  # Aumentado de 12 para 13

    # Tamanho de fonte para valores nas barras (quando show_values=True)
    BAR_VALUE_FONT_SIZE = 13  # Aumentado de 11 para 13

    # ==================== CONFIGURAÇÕES DE ESPAÇAMENTO ====================

    # Margem entre rótulos e barras (em pixels)
    # Para barras horizontais: margem esquerda (antes dos rótulos Y)
    # Para barras verticais: margem inferior (antes dos rótulos X)
    LABEL_TO_BAR_GAP = 30  # Aumentado para afastar rótulos das barras

    # Margem base para o eixo categórico
    CATEGORY_AXIS_BASE_MARGIN = (
        30  # Reduzido de 150 para 120 para reduzir espaço branco
    )

    # Fator multiplicador para cálculo dinâmico de margem baseado no tamanho do texto
    MARGIN_CHAR_MULTIPLIER = 8  # Pixels por caractere

    # ==================== CONFIGURAÇÕES DE BARRAS ====================

    # Gap entre barras (0.0 = sem gap, 1.0 = gap máximo)
    BAR_GAP = 0.2  # Gap padrão de 20%

    # Gap entre grupos de barras (para gráficos compostos)
    BAR_GROUP_GAP = 0.1

    # ==================== CONFIGURAÇÕES DE GRID ====================

    # Exibir grid no eixo de valores
    SHOW_VALUE_GRID = True

    # Exibir grid no eixo categórico
    SHOW_CATEGORY_GRID = False

    # Cor do grid
    GRID_COLOR = "rgba(128, 128, 128, 0.2)"

    # ==================== CONFIGURAÇÕES DE AUTOMARGIN ====================

    # Permitir que Plotly ajuste margens automaticamente
    ENABLE_AUTOMARGIN = True

    # Padding adicional quando automargin está ativo
    AUTOMARGIN_PADDING = 10


class BarAesthetics:
    """
    Aplicador de configurações estéticas para gráficos de barras.

    Usa BarAestheticsConfig para aplicar configurações consistentes
    em todos os gráficos de barras.

    Exemplo de uso:
        >>> aesthetics = BarAesthetics()
        >>> fig = go.Figure(...)
        >>> aesthetics.apply_horizontal_bar_style(fig, categories)
    """

    def __init__(self, config: Optional[BarAestheticsConfig] = None):
        """
        Inicializa o aplicador de estética.

        Args:
            config: Configuração customizada (usa padrão se None)
        """
        self.config = config or BarAestheticsConfig()
        logger.debug("BarAesthetics inicializado com configurações centralizadas")

    def apply_horizontal_bar_style(
        self, fig: go.Figure, categories: list, show_grid: bool = True
    ) -> None:
        """
        Aplica estilo estético para gráficos de barras horizontais.

        Configurações aplicadas:
        - Tamanho de fonte aumentado para rótulos Y (categorias)
        - Espaçamento adequado entre rótulos e barras
        - Margem esquerda otimizada
        - Grid configurado

        Args:
            fig: Figure Plotly
            categories: Lista de categorias (para cálculo de margem)
            show_grid: Se deve mostrar grid no eixo X (valores)
        """
        # Calcular margem ideal baseada no tamanho máximo das categorias
        max_category_len = (
            max(len(str(cat)) for cat in categories) if categories else 20
        )
        optimal_margin = max(
            self.config.CATEGORY_AXIS_BASE_MARGIN,
            max_category_len * self.config.MARGIN_CHAR_MULTIPLIER,
        )

        # Aplicar configurações ao eixo Y (categorias)
        fig.update_yaxes(
            tickfont=dict(
                size=self.config.CATEGORY_LABEL_FONT_SIZE, family="Arial, sans-serif"
            ),
            showgrid=self.config.SHOW_CATEGORY_GRID,
            automargin=self.config.ENABLE_AUTOMARGIN,
        )

        # Aplicar configurações ao eixo X (valores)
        fig.update_xaxes(
            tickfont=dict(size=self.config.VALUE_LABEL_FONT_SIZE),
            showgrid=show_grid and self.config.SHOW_VALUE_GRID,
            gridcolor=self.config.GRID_COLOR,
        )

        # Atualizar layout com margens otimizadas
        fig.update_layout(
            margin=dict(
                l=optimal_margin + self.config.LABEL_TO_BAR_GAP,
                r=40,
                t=60,
                b=60,
                pad=self.config.AUTOMARGIN_PADDING
                if self.config.ENABLE_AUTOMARGIN
                else 0,
            ),
            bargap=self.config.BAR_GAP,
            bargroupgap=self.config.BAR_GROUP_GAP,
        )

        logger.info(
            f"Configuração estética aplicada em bar_horizontal: "
            f"margem_esquerda={optimal_margin}, font_size={self.config.CATEGORY_LABEL_FONT_SIZE}"
        )

    def apply_vertical_bar_style(
        self,
        fig: go.Figure,
        categories: list,
        show_grid: bool = True,
        rotate_labels: bool = False,
        rotation_angle: int = -45,
    ) -> None:
        """
        Aplica estilo estético para gráficos de barras verticais.

        Configurações aplicadas:
        - Tamanho de fonte aumentado para rótulos X (categorias)
        - Espaçamento adequado entre rótulos e barras
        - Margem inferior otimizada
        - Opção de rotação de rótulos
        - Grid configurado

        Args:
            fig: Figure Plotly
            categories: Lista de categorias (para cálculo de margem)
            show_grid: Se deve mostrar grid no eixo Y (valores)
            rotate_labels: Se deve rotacionar rótulos do eixo X
            rotation_angle: Ângulo de rotação (negativo = anti-horário)
        """
        # Calcular margem ideal baseada no tamanho máximo das categorias
        max_category_len = (
            max(len(str(cat)) for cat in categories) if categories else 20
        )

        # Para barras verticais, se houver rotação, precisamos de mais margem
        if rotate_labels:
            optimal_margin = max(
                self.config.CATEGORY_AXIS_BASE_MARGIN,
                int(
                    max_category_len * self.config.MARGIN_CHAR_MULTIPLIER * 0.7
                ),  # Ajuste para rotação
            )
        else:
            optimal_margin = self.config.CATEGORY_AXIS_BASE_MARGIN

        # Aplicar configurações ao eixo X (categorias)
        fig.update_xaxes(
            tickfont=dict(
                size=self.config.CATEGORY_LABEL_FONT_SIZE, family="Arial, sans-serif"
            ),
            tickangle=rotation_angle if rotate_labels else 0,
            showgrid=self.config.SHOW_CATEGORY_GRID,
            automargin=self.config.ENABLE_AUTOMARGIN,
        )

        # Aplicar configurações ao eixo Y (valores)
        fig.update_yaxes(
            tickfont=dict(size=self.config.VALUE_LABEL_FONT_SIZE),
            showgrid=show_grid and self.config.SHOW_VALUE_GRID,
            gridcolor=self.config.GRID_COLOR,
        )

        # Atualizar layout com margens otimizadas
        fig.update_layout(
            margin=dict(
                l=80,
                r=40,
                t=100,  # Aumentado de 60 para 100 para evitar corte de valores nas barras
                b=optimal_margin + self.config.LABEL_TO_BAR_GAP,
                pad=self.config.AUTOMARGIN_PADDING
                if self.config.ENABLE_AUTOMARGIN
                else 0,
            ),
            bargap=self.config.BAR_GAP,
            bargroupgap=self.config.BAR_GROUP_GAP,
        )

        logger.info(
            f"Configuração estética aplicada em bar_vertical: "
            f"margem_inferior={optimal_margin}, font_size={self.config.CATEGORY_LABEL_FONT_SIZE}, "
            f"rotacao={rotation_angle if rotate_labels else 0}°"
        )

    def configure_bar_value_labels(
        self, fig: go.Figure, orientation: str = "h"
    ) -> None:
        """
        Configura a aparência dos valores nas barras (quando show_values=True).

        Args:
            fig: Figure Plotly
            orientation: 'h' para horizontal, 'v' para vertical
        """
        fig.update_traces(
            textfont=dict(
                size=self.config.BAR_VALUE_FONT_SIZE, family="Arial, sans-serif"
            ),
            textposition="outside" if orientation == "h" else "outside",
        )

        logger.debug(
            f"Rótulos de valores configurados: font_size={self.config.BAR_VALUE_FONT_SIZE}"
        )
